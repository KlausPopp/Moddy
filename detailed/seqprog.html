

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Sequential Program Simulation &mdash; Moddy Discrete Event Simulator 2.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Model Checking" href="modelchecking.html" />
    <link rel="prev" title="Modelling with Finite State Machines" href="fsm.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Moddy Discrete Event Simulator
          

          
            
            <img src="../_static/moddy-logo-200px.png" class="logo" alt="Logo"/>
          
          </a>

          
            
            
              <div class="version">
                2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../intro.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quick_start.html">Quick Start</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Detailed User Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="coresim.html">Core Simulator</a></li>
<li class="toctree-l2"><a class="reference internal" href="fsm.html">Modelling with Finite State Machines</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Sequential Program Simulation</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#program-model">Program Model</a></li>
<li class="toctree-l3"><a class="reference internal" href="#communication-between-moddy-programs-and-other-moddy-parts">Communication between Moddy Programs and other Moddy Parts</a></li>
<li class="toctree-l3"><a class="reference internal" href="#buffering-input-ports">Buffering Input Ports</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#sampling-input-ports">Sampling Input Ports</a></li>
<li class="toctree-l4"><a class="reference internal" href="#queuing-input-ports">Queuing Input Ports</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#system-calls-for-sequential-programs">System Calls for Sequential Programs</a></li>
<li class="toctree-l3"><a class="reference internal" href="#concurrent-program-execution-rtos-simulation">Concurrent Program Execution/RTOS Simulation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#vsimpleprog-and-vthread">VSimpleProg and VThread</a></li>
<li class="toctree-l3"><a class="reference internal" href="#remote-controlled-vthreads">Remote Controlled vThreads</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="modelchecking.html">Model Checking</a></li>
<li class="toctree-l2"><a class="reference internal" href="visualization.html">Visualisation</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/index.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/index.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../install.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developer.html">Developer Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../migrating_to_moddy2.html">Porting from Moddy 1 to 2</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Moddy Discrete Event Simulator</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Detailed User Guide</a> &raquo;</li>
        
      <li>Sequential Program Simulation</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/detailed/seqprog.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="sequential-program-simulation">
<span id="detailed-seqprog"></span><h1>Sequential Program Simulation<a class="headerlink" href="#sequential-program-simulation" title="Permalink to this headline">¶</a></h1>
<p>With the message and timer callbacks explained before, you can model already everything.</p>
<p>However, when you want to model a sequential execution,
it can be quite cumbersome to do this with the event based mechanism.
For example if you want to model the execution of a software program like this</p>
<blockquote>
<div><ul class="simple">
<li><p>Get inputs (from Moddy messages), takes 100 µs</p></li>
<li><p>Calculate, takes 1ms</p></li>
<li><p>Set outputs, takes 200 µs</p></li>
</ul>
</div></blockquote>
<p>With the event based mechanism, you would need a state machine in the timer’s callback routine,
which is not easy to understand.</p>
<p>So Moddy allows an alternative way to model those sequential programs, simply called “Programs” in the following.</p>
<p>To create a “program”, your Part must be a subclass of either <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread" title="moddy.vthread.VThread"><code class="xref py py-class docutils literal notranslate"><span class="pre">VThread</span></code></a>
or <a class="reference internal" href="../reference/vthread.html#moddy.vt_sched_rtos.VSimpleProg" title="moddy.vt_sched_rtos.VSimpleProg"><code class="xref py py-class docutils literal notranslate"><span class="pre">VSimpleProg</span></code></a>.
(More about the difference between them in chapter <a class="reference internal" href="#diff-simpleprog-and-vthread"><span class="std std-ref">VSimpleProg and VThread</span></a>).</p>
<div class="section" id="program-model">
<h2>Program Model<a class="headerlink" href="#program-model" title="Permalink to this headline">¶</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Client</span><span class="p">(</span><span class="n">moddy</span><span class="o">.</span><span class="n">VSimpleProg</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sim</span><span class="o">=</span><span class="n">sim</span><span class="p">,</span> <span class="n">obj_name</span><span class="o">=</span><span class="s2">&quot;Client&quot;</span><span class="p">,</span> <span class="n">parent_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_ports</span><span class="p">(</span><span class="s1">&#39;QueuingIO&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;net_port&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">run_vthread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mf">1.2</span><span class="o">*</span><span class="n">MS</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">net_port</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="o">*</span><span class="n">US</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">US</span><span class="p">,</span> <span class="s1">&#39;TX1&#39;</span><span class="p">,</span> <span class="n">whiteOnBlue</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">net_port</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;test1&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="o">*</span><span class="n">US</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">US</span><span class="p">,</span> <span class="s1">&#39;TX2&#39;</span><span class="p">,</span> <span class="n">whiteOnRed</span><span class="p">)</span>
</pre></div>
</div>
<div class="figure align-default">
<img alt="../_images/0200_vthread.png" src="../_images/0200_vthread.png" />
</div>
<p>In the above example, you see a very simple sequential program, that is</p>
<blockquote>
<div><ul class="simple">
<li><p>Idle (waiting) for 1.2ms</p></li>
<li><p>Performing a send “TX1” operation, which takes 100 µs</p></li>
<li><p>Performing a send “TX2” operation, which takes 100 µs</p></li>
</ul>
</div></blockquote>
<p>Moddy parts derived from <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread" title="moddy.vthread.VThread"><code class="xref py py-class docutils literal notranslate"><span class="pre">VThread</span></code></a> or <a class="reference internal" href="../reference/vthread.html#moddy.vt_sched_rtos.VSimpleProg" title="moddy.vt_sched_rtos.VSimpleProg"><code class="xref py py-class docutils literal notranslate"><span class="pre">VSimpleProg</span></code></a>
must implement a method <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.run_vthread" title="moddy.vthread.VThread.run_vthread"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run_vthread()</span></code></a>. This method contains your sequential program model.</p>
<p>It is called at the start of the simulation time (simulation time 0).</p>
<p>The <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.run_vthread" title="moddy.vthread.VThread.run_vthread"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run_vthread()</span></code></a> method is not supposed to exit/return, that’s why it contains an endless loop.
(However, for remote controlled vThreads it makes sense to exit/return, see <a class="reference internal" href="#remote-controlled-thread"><span class="std std-ref">Remote Controlled vThreads</span></a>
for more information)</p>
<p>Since Moddy 1.8, you don’t need a subclass of <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread" title="moddy.vthread.VThread"><code class="xref py py-class docutils literal notranslate"><span class="pre">VThread</span></code></a> or <a class="reference internal" href="../reference/vthread.html#moddy.vt_sched_rtos.VSimpleProg" title="moddy.vt_sched_rtos.VSimpleProg"><code class="xref py py-class docutils literal notranslate"><span class="pre">VSimpleProg</span></code></a> anymore.
You can pass instead a function to the constructor of <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread" title="moddy.vthread.VThread"><code class="xref py py-class docutils literal notranslate"><span class="pre">VThread</span></code></a> or <a class="reference internal" href="../reference/vthread.html#moddy.vt_sched_rtos.VSimpleProg" title="moddy.vt_sched_rtos.VSimpleProg"><code class="xref py py-class docutils literal notranslate"><span class="pre">VSimpleProg</span></code></a> via
the <cite>target</cite> parameter. This function (in the example below <code class="docutils literal notranslate"><span class="pre">bob_prog</span></code> is then called from <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.run_vthread" title="moddy.vthread.VThread.run_vthread"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run_vthread()</span></code></a>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bob_prog</span><span class="p">(</span><span class="bp">self</span><span class="p">:</span> <span class="n">moddy</span><span class="o">.</span><span class="n">VSimpleProg</span><span class="p">):</span>
    <span class="c1"># bob starts talking</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;Hi Joe&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_msg</span><span class="p">(</span><span class="bp">None</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">head</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">simu</span> <span class="o">=</span> <span class="n">moddy</span><span class="o">.</span><span class="n">Sim</span><span class="p">()</span>

    <span class="n">VSimpleProg</span><span class="p">(</span> <span class="n">sim</span><span class="o">=</span><span class="n">simu</span><span class="p">,</span> <span class="n">obj_name</span><span class="o">=</span><span class="s2">&quot;Bob&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">bob_prog</span><span class="p">,</span> <span class="n">elems</span><span class="o">=</span><span class="p">{</span> <span class="s1">&#39;QueuingIO&#39;</span><span class="p">:</span> <span class="s1">&#39;head&#39;</span> <span class="p">}</span> <span class="p">)</span>
</pre></div>
</div>
<p>The program model in <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.run_vthread" title="moddy.vthread.VThread.run_vthread"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run_vthread()</span></code></a> can control the timing of the program via “system calls”:</p>
<blockquote>
<div><ul class="simple">
<li><p><a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.wait" title="moddy.vthread.VThread.wait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait()</span></code></a> delays the program execution for a specified time or
until an event occurred, indicating that the program is idle. No status box is shown on
the sequence diagram life line while a program is waiting</p></li>
<li><p><a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.busy" title="moddy.vthread.VThread.busy"><code class="xref py py-meth docutils literal notranslate"><span class="pre">busy()</span></code></a> delays the program execution for the specified time.
A user defined status box (e.g. ‘TX1’ in the example above occurs) is shown on the life line
while the program is busy.</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Moddy executes each <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.run_vthread" title="moddy.vthread.VThread.run_vthread"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run_vthread()</span></code></a> method in a separate python thread.
But don’t worry: Race conditions resulting from concurrent execution cannot occur in Moddy,
because Moddy executes exactly only one thread at each time, either the simulator thread or one of the vThreads.
There is no need to protect your data via mutexes.</p>
</div>
</div>
<div class="section" id="communication-between-moddy-programs-and-other-moddy-parts">
<h2>Communication between Moddy Programs and other Moddy Parts<a class="headerlink" href="#communication-between-moddy-programs-and-other-moddy-parts" title="Permalink to this headline">¶</a></h2>
<p>Like normal Moddy parts, Moddy Programs shall communicate with other parts only via Moddy messages.
To send messages, a Moddy program can use standard output ports. There is no difference to other parts.</p>
<p>But a standard input port executes a callback method.
It cannot tell the program that a message has been received (other than setting a global variable).
For this reason, Moddy provides “buffering input ports”.</p>
</div>
<div class="section" id="buffering-input-ports">
<h2>Buffering Input Ports<a class="headerlink" href="#buffering-input-ports" title="Permalink to this headline">¶</a></h2>
<p>A buffering input port buffers received messages in the part’s local memory and eventually wakes up the program.
There are two types of buffering ports</p>
<blockquote>
<div><ul>
<li><p>Sampling Port: A sampling port is used if the receiver is only interested in the most recent message.</p>
<blockquote>
<div><ul class="simple">
<li><p>A sampling port buffers only the last received message.</p></li>
<li><p>A read from the sampling buffer does not consume the buffered message</p></li>
</ul>
</div></blockquote>
</li>
<li><p>Queuing Port: A queuing port is used if the receiver wants to get all messages.</p>
<blockquote>
<div><ul class="simple">
<li><p>A queuing port buffers all messages in a fifo queue. The queue depth is infinite.</p></li>
<li><p>A read from the buffer consumes the first message</p></li>
</ul>
</div></blockquote>
</li>
</ul>
</div></blockquote>
<p>Buffering input ports are derived from <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VtInPort" title="moddy.vthread.VtInPort"><code class="xref py py-class docutils literal notranslate"><span class="pre">VtInPort</span></code></a>.</p>
<p>A program reads a message from a buffering ports via the <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VtInPort.read_msg" title="moddy.vthread.VtInPort.read_msg"><code class="xref py py-meth docutils literal notranslate"><span class="pre">read_msg()</span></code></a> method.</p>
<p>It can check the number of messages in the buffer through the <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VtInPort.n_msg" title="moddy.vthread.VtInPort.n_msg"><code class="xref py py-meth docutils literal notranslate"><span class="pre">n_msg()</span></code></a> method.</p>
<p>A program can wait for new message using the <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.wait" title="moddy.vthread.VThread.wait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait()</span></code></a> method, or alternatively
wait for a message and read the first available message through <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.wait_for_msg" title="moddy.vthread.VThread.wait_for_msg"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_for_msg()</span></code></a>.</p>
<p>The exact behavior depends on the type of buffer port (Sampling or Queuing) and will be explained in the following.</p>
<div class="section" id="sampling-input-ports">
<h3>Sampling Input Ports<a class="headerlink" href="#sampling-input-ports" title="Permalink to this headline">¶</a></h3>
<p>Recall from previous chapter:</p>
<blockquote>
<div><ul class="simple">
<li><p>A sampling port buffers only the last received message.</p></li>
<li><p>A read from the sampling buffer does not consume the buffered message</p></li>
</ul>
</div></blockquote>
<p>A sampling input port (<a class="reference internal" href="../reference/vthread.html#moddy.vthread.VtSamplingInPort" title="moddy.vthread.VtSamplingInPort"><code class="xref py py-class docutils literal notranslate"><span class="pre">VtSamplingInPort</span></code></a>) is created with the <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.create_ports" title="moddy.vthread.VThread.create_ports"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_ports()</span></code></a>
method, usually from the program’s constructor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">create_ports</span><span class="p">(</span><span class="s1">&#39;SamplingIn&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;in_p1&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VtInPort.read_msg" title="moddy.vthread.VtInPort.read_msg"><code class="xref py py-meth docutils literal notranslate"><span class="pre">read_msg()</span></code></a> method on a sampling input port returns the most recent message received.
If no message at all was received, it returns either the “default” (if provided) or raises a BufferError exception.</p>
<p>If you call <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VtInPort.read_msg" title="moddy.vthread.VtInPort.read_msg"><code class="xref py py-meth docutils literal notranslate"><span class="pre">read_msg()</span></code></a> and now new message has arrived since the
last <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VtInPort.read_msg" title="moddy.vthread.VtInPort.read_msg"><code class="xref py py-meth docutils literal notranslate"><span class="pre">read_msg()</span></code></a> call, you get the same message again. Example:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_p1</span><span class="o">.</span><span class="n">read_msg</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;123&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VtInPort.n_msg" title="moddy.vthread.VtInPort.n_msg"><code class="xref py py-meth docutils literal notranslate"><span class="pre">n_msg()</span></code></a> method returns 0 if no message was received at 0, or 1 otherwise.
A program can call <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.wait" title="moddy.vthread.VThread.wait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait()</span></code></a> so that is woken up if a message arrives on the port:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">in_p1</span><span class="p">])</span>
</pre></div>
</div>
<p>A sampling input port wakes up a waiting program with every message that arrives.</p>
<p>The following snippet demonstrates the use of a sampling port.
<em>MyThread1</em> is a program that has a sampling input port <em>in_p1</em>, while <em>StimThread</em> is firing messages to that port.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyThread1</span><span class="p">(</span><span class="n">moddy</span><span class="o">.</span><span class="n">VSimpleProg</span><span class="p">):</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span> <span class="p">):</span>
         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sim</span><span class="o">=</span><span class="n">sim</span><span class="p">,</span> <span class="n">obj_name</span><span class="o">=</span><span class="s1">&#39;Thread&#39;</span><span class="p">,</span> <span class="n">parent_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">create_ports</span><span class="p">(</span><span class="s1">&#39;SamplingIn&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;in_p1&#39;</span><span class="p">])</span>

     <span class="k">def</span> <span class="nf">show_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_p1</span><span class="o">.</span><span class="n">read_msg</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s1">&#39;No message&#39;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

     <span class="k">def</span> <span class="nf">run_vthread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">cycle</span><span class="o">=</span><span class="mi">0</span>
         <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
             <span class="n">cycle</span> <span class="o">+=</span> <span class="mi">1</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">show_msg</span><span class="p">()</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">(</span><span class="mi">18</span><span class="p">,</span><span class="n">cycle</span><span class="p">,</span> <span class="n">busy_appearance</span><span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">show_msg</span><span class="p">()</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="n">cycle</span><span class="p">,</span> <span class="n">busy_appearance</span><span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">20</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">in_p1</span><span class="p">])</span>


 <span class="k">class</span> <span class="nc">StimThread</span><span class="p">(</span><span class="n">moddy</span><span class="o">.</span><span class="n">VSimpleProg</span><span class="p">):</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span> <span class="p">):</span>
         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sim</span><span class="o">=</span><span class="n">sim</span><span class="p">,</span> <span class="n">obj_name</span><span class="o">=</span><span class="s1">&#39;Stim&#39;</span><span class="p">,</span> <span class="n">parent_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">create_ports</span><span class="p">(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;to_t1_port&#39;</span><span class="p">])</span>

     <span class="k">def</span> <span class="nf">run_vthread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
         <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
             <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">15</span><span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">to_t1_port</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;hello</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<p>This would result in the following sequence diagram:</p>
<div class="figure align-default">
<img alt="../_images/0210_samplinginport.png" src="../_images/0210_samplinginport.png" />
</div>
</div>
<div class="section" id="queuing-input-ports">
<h3>Queuing Input Ports<a class="headerlink" href="#queuing-input-ports" title="Permalink to this headline">¶</a></h3>
<p>Recall from previous chapter:</p>
<blockquote>
<div><ul class="simple">
<li><p>A queuing port buffers all messages in a fifo queue. The queue depth is infinite.</p></li>
<li><p>A read from the buffer consumes the first message</p></li>
</ul>
</div></blockquote>
<p>A queuing input port (<a class="reference internal" href="../reference/vthread.html#moddy.vthread.VtQueuingInPort" title="moddy.vthread.VtQueuingInPort"><code class="xref py py-class docutils literal notranslate"><span class="pre">VtQueuingInPort</span></code></a>) is created with the <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.create_ports" title="moddy.vthread.VThread.create_ports"><code class="xref py py-meth docutils literal notranslate"><span class="pre">create_ports()</span></code></a>
method, usually from the program’s constructor:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">create_ports</span><span class="p">(</span><span class="s1">&#39;QueuingIn&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;in_p1&#39;</span><span class="p">])</span>
</pre></div>
</div>
<p>The <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VtInPort.read_msg" title="moddy.vthread.VtInPort.read_msg"><code class="xref py py-meth docutils literal notranslate"><span class="pre">read_msg()</span></code></a> method on a queuing input port returns the first message of the queue.
If no message is in the queue, it raises a BufferError exception.</p>
<p>The <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VtInPort.n_msg" title="moddy.vthread.VtInPort.n_msg"><code class="xref py py-meth docutils literal notranslate"><span class="pre">n_msg()</span></code></a> method returns the number of messages in the queue (0 if none).</p>
<p>A program can call <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.wait" title="moddy.vthread.VThread.wait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait()</span></code></a> so that is woken up when a the first message an empty queue arrives on the port:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">in_p1</span><span class="p">])</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Call <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.wait" title="moddy.vthread.VThread.wait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait()</span></code></a> only on empty queuing ports,
otherwise the program will not be woken up (because the wakeup happens only at empty-&gt;non-empty transitions)!
Alternatively, use <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.wait_for_msg" title="moddy.vthread.VThread.wait_for_msg"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_for_msg()</span></code></a></p>
</div>
<p>The following snippet demonstrates the use of a queuing port.
<em>MyThread1</em> is a program that has a queuing input port <em>in_p1</em>, while <em>StimThread</em> is firing messages to that port.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyThread1</span><span class="p">(</span><span class="n">moddy</span><span class="o">.</span><span class="n">VSimpleProg</span><span class="p">):</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span> <span class="p">):</span>
         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sim</span><span class="o">=</span><span class="n">sim</span><span class="p">,</span> <span class="n">obj_name</span><span class="o">=</span><span class="s1">&#39;Thread&#39;</span><span class="p">,</span> <span class="n">parent_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">create_ports</span><span class="p">(</span><span class="s1">&#39;QueuingIn&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;in_p1&#39;</span><span class="p">])</span>

     <span class="k">def</span> <span class="nf">get_all_msg</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">lst_msg</span> <span class="o">=</span> <span class="p">[]</span>
         <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
             <span class="k">try</span><span class="p">:</span>
                 <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_p1</span><span class="o">.</span><span class="n">read_msg</span><span class="p">()</span>
                 <span class="n">lst_msg</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
             <span class="k">except</span> <span class="n">BufferError</span><span class="p">:</span>
                 <span class="k">break</span>

         <span class="bp">self</span><span class="o">.</span><span class="n">annotation</span><span class="p">(</span><span class="n">lst_msg</span><span class="p">)</span>


     <span class="k">def</span> <span class="nf">run_vthread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">cycle</span><span class="o">=</span><span class="mi">0</span>
         <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
             <span class="n">cycle</span> <span class="o">+=</span> <span class="mi">1</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">(</span><span class="mi">33</span><span class="p">,</span> <span class="n">cycle</span><span class="p">,</span> <span class="n">busy_appearance</span><span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">get_all_msg</span><span class="p">()</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">in_p1</span><span class="p">])</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">get_all_msg</span><span class="p">()</span>


 <span class="k">class</span> <span class="nc">StimThread</span><span class="p">(</span><span class="n">moddy</span><span class="o">.</span><span class="n">VSimpleProg</span><span class="p">):</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span> <span class="p">):</span>
         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sim</span><span class="o">=</span><span class="n">sim</span><span class="p">,</span> <span class="n">obj_name</span><span class="o">=</span><span class="s1">&#39;Stim&#39;</span><span class="p">,</span> <span class="n">parent_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">create_ports</span><span class="p">(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;to_t1_port&#39;</span><span class="p">])</span>

     <span class="k">def</span> <span class="nf">run_vthread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="n">count</span><span class="o">=</span><span class="mi">0</span>
         <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
             <span class="n">count</span><span class="o">+=</span><span class="mi">1</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">15</span><span class="p">,[])</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">to_t1_port</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;hello</span><span class="si">%d</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">count</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
</pre></div>
</div>
<div class="figure align-default">
<img alt="../_images/0220_queuingport.png" src="../_images/0220_queuingport.png" />
</div>
<p>Since Moddy 1.8, <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.wait_for_msg" title="moddy.vthread.VThread.wait_for_msg"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait_for_msg()</span></code></a> is available. This method waits for a message on any of the
specified ports and returns the first available message:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_vthread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
        <span class="c1"># Wait for a message on either in_p1 or in_p2.</span>
        <span class="c1"># Because 2 ports have been specified, wait_for_msg returns a tuple with (msg, port) or None</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_msg</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">in_p1</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_p2</span><span class="p">])</span>

        <span class="c1"># Wait for a message on in_p2.</span>
        <span class="c1"># Because 1 port has been specified, wait_for_msg returns a just the msg or None</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_msg</span><span class="p">(</span><span class="mi">30</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">in_p2</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="system-calls-for-sequential-programs">
<h2>System Calls for Sequential Programs<a class="headerlink" href="#system-calls-for-sequential-programs" title="Permalink to this headline">¶</a></h2>
<p>In the previous chapters, the system calls <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.wait" title="moddy.vthread.VThread.wait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait()</span></code></a> and <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.busy" title="moddy.vthread.VThread.busy"><code class="xref py py-meth docutils literal notranslate"><span class="pre">busy()</span></code></a>
were already briefly introduced. Now in more detail:</p>
<p><a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.wait" title="moddy.vthread.VThread.wait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait()</span></code></a> delays the program execution for a specified time or until an event occurred.
The model is indicating with <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.wait" title="moddy.vthread.VThread.wait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait()</span></code></a> that the program is idle.
Therefore no status box is shown on the sequence diagram life line while a program is waiting.</p>
<dl class="function">
<dt>
<code class="sig-prename descclassname">moddy.vthread.VThread.</code><code class="sig-name descname">wait</code><span class="sig-paren">(</span><em class="sig-param">self</em>, <em class="sig-param">timeout</em>, <em class="sig-param">ev_list=[]</em><span class="sig-paren">)</span></dt>
<dd><p>Suspend vThread until one of the events in <cite>ev_list</cite> occurs or timeout</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>timeout</strong> – time to wait for events. If None, wait forever.             A timeout value of 0 is invalid.</p></li>
<li><p><strong>ev_list</strong> (<a class="reference external" href="https://docs.python.org/3/library/stdtypes.html#list" title="(in Python v3.9)"><em>list</em></a>) – list of events to wait for.             Events can be <code class="xref py py-class docutils literal notranslate"><span class="pre">VtSamplingInPort</span></code>,              <code class="xref py py-class docutils literal notranslate"><span class="pre">VtQueuingInPort</span></code>, <code class="xref py py-class docutils literal notranslate"><span class="pre">VtIOPort</span></code>,              or <code class="xref py py-class docutils literal notranslate"><span class="pre">VtTimer</span></code> object.              If ev_list is empty (or omitted),              wait for timeout unconditionally.</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>‘ok’ if one of the events has been triggered         (it does not tell you which one), ‘timeout’ if timeout</p>
</dd>
<dt class="field-odd">Raises</dt>
<dd class="field-odd"><p><a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.TerminateException" title="moddy.vthread.VThread.TerminateException"><strong>TerminateException</strong></a> – if simulator stopped</p>
</dd>
</dl>
</dd></dl>

<p><a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.busy" title="moddy.vthread.VThread.busy"><code class="xref py py-meth docutils literal notranslate"><span class="pre">busy()</span></code></a> delays the program execution for the specified time.
The model is indicating with <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.busy" title="moddy.vthread.VThread.busy"><code class="xref py py-meth docutils literal notranslate"><span class="pre">busy()</span></code></a> that the program is performing some operation.
Therefore, a user defined status box appears on the life line while the program is busy.</p>
<dl class="function">
<dt>
<code class="sig-prename descclassname">moddy.vthread.VThread.</code><code class="sig-name descname">busy</code><span class="sig-paren">(</span><em class="sig-param">self</em>, <em class="sig-param">time</em>, <em class="sig-param">status</em>, <em class="sig-param">status_appearance={}</em><span class="sig-paren">)</span></dt>
<dd><p>tell the scheduler how much time the current operation takes</p>
<dl class="field-list simple">
<dt class="field-odd">Parameters</dt>
<dd class="field-odd"><ul class="simple">
<li><p><strong>time</strong> – the busy time. May be 0</p></li>
<li><p><strong>status</strong> – the status text shown on the sequence diagram life line</p></li>
<li><p><strong>status_appearance</strong> – defines the decoration of the status             box in the sequence diagram.
See svgSeqD.statusBox</p></li>
</ul>
</dd>
<dt class="field-even">Returns</dt>
<dd class="field-even"><p>always ‘ok’</p>
</dd>
<dt class="field-odd">Raises</dt>
<dd class="field-odd"><p><a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.TerminateException" title="moddy.vthread.VThread.TerminateException"><strong>TerminateException</strong></a> – if simulator stopped</p>
</dd>
</dl>
</dd></dl>

</div>
<div class="section" id="concurrent-program-execution-rtos-simulation">
<h2>Concurrent Program Execution/RTOS Simulation<a class="headerlink" href="#concurrent-program-execution-rtos-simulation" title="Permalink to this headline">¶</a></h2>
<p>Moddy comes with a simulation of a simple RTOS (real time operating system) scheduler (<code class="xref py py-class docutils literal notranslate"><span class="pre">vt_sched_rtos:vt_sched_rtos</span></code>).</p>
<p>With this feature, you can model SW threads that run concurrently on a single CPU core.
The scheduler has the following features:</p>
<blockquote>
<div><ul class="simple">
<li><p>16 thread priorities - 0 is highest priority</p></li>
<li><p>Priority based scheduling. Low priority threads run only if no higher thread ready.</p></li>
<li><p>Threads with same priority will be scheduled round robin
(when one of the same priority threads releases the processor,
the next same priority thread which is ready is selected).
Note that the round robin occurs not periodically.
It happens only when one task executes <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.wait" title="moddy.vthread.VThread.wait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait()</span></code></a>.</p></li>
</ul>
</div></blockquote>
<p>First, you create the scheduler object:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">sched</span><span class="o">=</span> <span class="n">vt_sched_rtos</span><span class="p">(</span><span class="n">sim</span><span class="o">=</span><span class="n">simu</span><span class="p">,</span> <span class="n">obj_name</span><span class="o">=</span><span class="s2">&quot;sched&quot;</span><span class="p">,</span> <span class="n">parent_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
</pre></div>
</div>
<p>Then you add the threads (subclasses of VThread) that shall be scheduled by the scheduler:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">t1</span> <span class="o">=</span> <span class="n">MyThread1</span><span class="p">(</span><span class="n">simu</span><span class="p">)</span>
<span class="n">t2</span> <span class="o">=</span> <span class="n">MyThread2</span><span class="p">(</span><span class="n">simu</span><span class="p">)</span>
<span class="n">t3</span> <span class="o">=</span> <span class="n">MyThread3</span><span class="p">(</span><span class="n">simu</span><span class="p">)</span>
<span class="n">sched</span><span class="o">.</span><span class="n">add_vthread</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">prio</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">sched</span><span class="o">.</span><span class="n">add_vthread</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="n">prio</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
<span class="n">sched</span><span class="o">.</span><span class="n">add_vthread</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="n">prio</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Example snippet:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyThread1</span><span class="p">(</span><span class="n">moddy</span><span class="o">.</span><span class="n">VThread</span><span class="p">):</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span> <span class="p">):</span>
         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sim</span><span class="o">=</span><span class="n">sim</span><span class="p">,</span> <span class="n">obj_name</span><span class="o">=</span><span class="s1">&#39;hiThread&#39;</span><span class="p">,</span> <span class="n">parent_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
     <span class="k">def</span> <span class="nf">run_vthread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="k">print</span><span class="p">(</span><span class="s2">&quot;   VtHi1&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="n">busy_appearance</span><span class="p">)</span>
         <span class="k">print</span><span class="p">(</span><span class="s2">&quot;   VtHi2&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">20</span><span class="p">,[])</span>
         <span class="k">print</span><span class="p">(</span><span class="s2">&quot;   VtHi3&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="n">busy_appearance</span><span class="p">)</span>
         <span class="k">print</span><span class="p">(</span><span class="s2">&quot;   VtHi4&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">100</span><span class="p">,[])</span>
         <span class="k">print</span><span class="p">(</span><span class="s2">&quot;   VtHi5&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">100</span><span class="p">,[])</span>
         <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
             <span class="k">print</span><span class="p">(</span><span class="s2">&quot;   VtHi5&quot;</span><span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="n">busy_appearance</span><span class="p">)</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">5</span><span class="p">,[])</span>

 <span class="k">class</span> <span class="nc">MyThread2</span><span class="p">(</span><span class="n">moddy</span><span class="o">.</span><span class="n">VThread</span><span class="p">):</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span> <span class="p">):</span>
         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sim</span><span class="o">=</span><span class="n">sim</span><span class="p">,</span> <span class="n">obj_name</span><span class="o">=</span><span class="s1">&#39;lowThreadA&#39;</span><span class="p">,</span> <span class="n">parent_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
     <span class="k">def</span> <span class="nf">run_vthread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="k">print</span><span class="p">(</span><span class="s2">&quot;   VtLoA1&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="n">busy_appearance</span><span class="p">)</span>
         <span class="k">print</span><span class="p">(</span><span class="s2">&quot;   VtLoA2&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">20</span><span class="p">,[])</span>
         <span class="k">print</span><span class="p">(</span><span class="s2">&quot;   VtLoA3&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="n">busy_appearance</span><span class="p">)</span>
         <span class="k">print</span><span class="p">(</span><span class="s2">&quot;   VtLoA4&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="n">busy_appearance</span><span class="p">)</span>

 <span class="k">class</span> <span class="nc">MyThread3</span><span class="p">(</span><span class="n">moddy</span><span class="o">.</span><span class="n">VThread</span><span class="p">):</span>
     <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span> <span class="p">):</span>
         <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sim</span><span class="o">=</span><span class="n">sim</span><span class="p">,</span> <span class="n">obj_name</span><span class="o">=</span><span class="s1">&#39;lowThreadB&#39;</span><span class="p">,</span> <span class="n">parent_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
     <span class="k">def</span> <span class="nf">run_vthread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
         <span class="k">print</span><span class="p">(</span><span class="s2">&quot;   VtLoB1&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span><span class="s1">&#39;1&#39;</span><span class="p">,</span><span class="n">busy_appearance</span><span class="p">)</span>
         <span class="k">print</span><span class="p">(</span><span class="s2">&quot;   VtLoB2&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">20</span><span class="p">,[])</span>
         <span class="k">print</span><span class="p">(</span><span class="s2">&quot;   VtLoB3&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">(</span><span class="mi">100</span><span class="p">,</span><span class="s1">&#39;2&#39;</span><span class="p">,</span><span class="n">busy_appearance</span><span class="p">)</span>
         <span class="k">print</span><span class="p">(</span><span class="s2">&quot;   VtLoB4&quot;</span><span class="p">)</span>
         <span class="bp">self</span><span class="o">.</span><span class="n">busy</span><span class="p">(</span><span class="mi">250</span><span class="p">,</span><span class="s1">&#39;3&#39;</span><span class="p">,</span><span class="n">busy_appearance</span><span class="p">)</span>

 <span class="n">simu</span> <span class="o">=</span> <span class="n">sim</span><span class="p">()</span>
 <span class="n">sched</span><span class="o">=</span> <span class="n">vt_sched_rtos</span><span class="p">(</span><span class="n">sim</span><span class="o">=</span><span class="n">simu</span><span class="p">,</span> <span class="n">obj_name</span><span class="o">=</span><span class="s2">&quot;sched&quot;</span><span class="p">,</span> <span class="n">parent_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>

 <span class="n">t1</span> <span class="o">=</span> <span class="n">MyThread1</span><span class="p">(</span><span class="n">simu</span><span class="p">)</span>
 <span class="n">t2</span> <span class="o">=</span> <span class="n">MyThread2</span><span class="p">(</span><span class="n">simu</span><span class="p">)</span>
 <span class="n">t3</span> <span class="o">=</span> <span class="n">MyThread3</span><span class="p">(</span><span class="n">simu</span><span class="p">)</span>
 <span class="n">sched</span><span class="o">.</span><span class="n">add_vthread</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
 <span class="n">sched</span><span class="o">.</span><span class="n">add_vthread</span><span class="p">(</span><span class="n">t2</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
 <span class="n">sched</span><span class="o">.</span><span class="n">add_vthread</span><span class="p">(</span><span class="n">t3</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>Resulting in the following sequence diagram:</p>
<div class="figure align-default">
<img alt="../_images/0230_rtos.png" src="../_images/0230_rtos.png" />
</div>
<p>Note: The “PE” status indicator tells you that the thread is “preempted”, i.e.
it would be ready to run, but it has to wait for the CPU resource, because a higher priority thread is busy.</p>
</div>
<div class="section" id="vsimpleprog-and-vthread">
<span id="diff-simpleprog-and-vthread"></span><h2>VSimpleProg and VThread<a class="headerlink" href="#vsimpleprog-and-vthread" title="Permalink to this headline">¶</a></h2>
<p><a class="reference internal" href="../reference/vthread.html#moddy.vt_sched_rtos.VSimpleProg" title="moddy.vt_sched_rtos.VSimpleProg"><code class="xref py py-class docutils literal notranslate"><span class="pre">VSimpleProg</span></code></a> is a specialization of <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread" title="moddy.vthread.VThread"><code class="xref py py-class docutils literal notranslate"><span class="pre">VThread</span></code></a>.
<a class="reference internal" href="../reference/vthread.html#moddy.vt_sched_rtos.VSimpleProg" title="moddy.vt_sched_rtos.VSimpleProg"><code class="xref py py-class docutils literal notranslate"><span class="pre">VSimpleProg</span></code></a> uses an exclusive scheduler for the program, so there are no concurrent threads.
A <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread" title="moddy.vthread.VThread"><code class="xref py py-class docutils literal notranslate"><span class="pre">VThread</span></code></a> must be explicitly assigned to a scheduler.</p>
<p>Example for a VSimpleProg. This creates a moddy part “Producer” with a single thread attached:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Producer</span><span class="p">(</span><span class="n">moddy</span><span class="o">.</span><span class="n">VSimpleProg</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">sim</span><span class="o">=</span><span class="n">sim</span><span class="p">,</span> <span class="n">obj_name</span><span class="o">=</span><span class="s2">&quot;Producer&quot;</span><span class="p">,</span> <span class="n">parent_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">create_ports</span><span class="p">(</span><span class="s1">&#39;out&#39;</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;net_port&#39;</span><span class="p">])</span>

    <span class="k">def</span> <span class="nf">run_vthread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="mi">100</span><span class="o">*</span><span class="n">US</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">net_port</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s1">&#39;test&#39;</span><span class="p">,</span> <span class="mi">100</span><span class="o">*</span><span class="n">US</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="remote-controlled-vthreads">
<span id="remote-controlled-thread"></span><h2>Remote Controlled vThreads<a class="headerlink" href="#remote-controlled-vthreads" title="Permalink to this headline">¶</a></h2>
<p>Remote Controlled vThreads are for instance useful to model computer systems that execute software,
but only if the computer is turned on, and another moddy part shall be able to turn on/off the computer.
Another example could be Software processes which shall be terminate-able and restart-able.</p>
<p>Normal vThreads are started automatically at the beginning of the simulation and they are supposed to
run until the end of the simulation.
Since Moddy 1.5.0, remote controlled vThreads are supported. Subclasses of vThreads like
<a class="reference internal" href="../reference/vthread.html#moddy.vt_sched_rtos.VSimpleProg" title="moddy.vt_sched_rtos.VSimpleProg"><code class="xref py py-class docutils literal notranslate"><span class="pre">VSimpleProg</span></code></a> also have the remote control feature.</p>
<p>Remote Controlled vThreads can be controlled (started and killed) from other moddy parts via a
moddy input port called <code class="docutils literal notranslate"><span class="pre">_thread_control_port</span></code>.</p>
<p>Remote Controlled vThreads are not started automatically, but wait for a “start” message on the _thread_control_port.
To create a remote controlled VThread, pass <code class="docutils literal notranslate"><span class="pre">remoteControlled=True</span></code> to the VThread’s __init__ method.
In another moddy part, create an output port and bind it to <code class="docutils literal notranslate"><span class="pre">_thread_control_port</span></code>.</p>
<p>Extract from tutorial 6_vthread_remote_controlled.py:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">MyRcThread</span><span class="p">(</span><span class="n">moddy</span><span class="o">.</span><span class="n">VThread</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sim</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span>
            <span class="n">sim</span><span class="o">=</span><span class="n">sim</span><span class="p">,</span>
            <span class="n">obj_name</span><span class="o">=</span><span class="s2">&quot;rcThread&quot;</span><span class="p">,</span>
            <span class="n">parent_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
            <span class="n">remote_controlled</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
        <span class="p">)</span>

<span class="c1"># This thread controls the remote controllable VThread</span>
<span class="k">def</span> <span class="nf">stim_prog</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

    <span class="c1"># @2s: initial start of rcTread</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wait_until</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rc_port</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;start&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="o">...</span>

    <span class="c1"># @180s: kill rcThread</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wait_until</span><span class="p">(</span><span class="mi">180</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">rc_port</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="s2">&quot;kill&quot;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">SIMU</span> <span class="o">=</span> <span class="n">moddy</span><span class="o">.</span><span class="n">Sim</span><span class="p">()</span>
    <span class="n">SIMU</span><span class="o">.</span><span class="n">tracing</span><span class="o">.</span><span class="n">set_display_time_unit</span><span class="p">(</span><span class="s2">&quot;s&quot;</span><span class="p">)</span>

    <span class="n">SCHED</span> <span class="o">=</span> <span class="n">moddy</span><span class="o">.</span><span class="n">VtSchedRtos</span><span class="p">(</span><span class="n">sim</span><span class="o">=</span><span class="n">SIMU</span><span class="p">,</span> <span class="n">obj_name</span><span class="o">=</span><span class="s2">&quot;sched&quot;</span><span class="p">,</span> <span class="n">parent_obj</span><span class="o">=</span><span class="bp">None</span><span class="p">)</span>
    <span class="n">rc_thread</span> <span class="o">=</span> <span class="n">MyRcThread</span><span class="p">(</span><span class="n">SIMU</span><span class="p">)</span>
    <span class="n">util_thread</span> <span class="o">=</span> <span class="n">moddy</span><span class="o">.</span><span class="n">VThread</span><span class="p">(</span>
        <span class="n">sim</span><span class="o">=</span><span class="n">SIMU</span><span class="p">,</span>
        <span class="n">obj_name</span><span class="o">=</span><span class="s2">&quot;utilThread&quot;</span><span class="p">,</span>
        <span class="n">target</span><span class="o">=</span><span class="n">util_prog</span><span class="p">,</span>
        <span class="n">elems</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;out&quot;</span><span class="p">:</span> <span class="s2">&quot;to_rc_port&quot;</span><span class="p">},</span>
    <span class="p">)</span>
    <span class="n">SCHED</span><span class="o">.</span><span class="n">add_vthread</span><span class="p">(</span><span class="n">rc_thread</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">SCHED</span><span class="o">.</span><span class="n">add_vthread</span><span class="p">(</span><span class="n">util_thread</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

    <span class="n">STIM</span> <span class="o">=</span> <span class="n">moddy</span><span class="o">.</span><span class="n">VSimpleProg</span><span class="p">(</span>
        <span class="n">sim</span><span class="o">=</span><span class="n">SIMU</span><span class="p">,</span> <span class="n">obj_name</span><span class="o">=</span><span class="s2">&quot;Stim&quot;</span><span class="p">,</span> <span class="n">target</span><span class="o">=</span><span class="n">stim_prog</span><span class="p">,</span> <span class="n">elems</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;out&quot;</span><span class="p">:</span> <span class="s2">&quot;rc_port&quot;</span><span class="p">}</span>
    <span class="p">)</span>

    <span class="n">SIMU</span><span class="o">.</span><span class="n">smart_bind</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span><span class="s2">&quot;rcThread._thread_control_port&quot;</span><span class="p">,</span> <span class="s2">&quot;Stim.rc_port&quot;</span><span class="p">],</span>
            <span class="p">[</span><span class="s2">&quot;utilThread.to_rc_port&quot;</span><span class="p">,</span> <span class="s2">&quot;rcThread.from_util_port&quot;</span><span class="p">],</span>
        <span class="p">]</span>
    <span class="p">)</span>
</pre></div>
</div>
<p>On the <code class="docutils literal notranslate"><span class="pre">_thread_control_port</span></code>, only two string parameters are supported:</p>
<blockquote>
<div><ul class="simple">
<li><p><strong>start</strong> - Start or restart the VThread’s <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.run_vthread" title="moddy.vthread.VThread.run_vthread"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run_vthread()</span></code></a> method.
If the <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.run_vthread" title="moddy.vthread.VThread.run_vthread"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run_vthread()</span></code></a> is already active, the start message is ignored.</p></li>
<li><p><strong>kill</strong> - Force the <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.run_vthread" title="moddy.vthread.VThread.run_vthread"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run_vthread()</span></code></a> to abort the
current <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.busy" title="moddy.vthread.VThread.busy"><code class="xref py py-meth docutils literal notranslate"><span class="pre">busy()</span></code></a> or <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.wait" title="moddy.vthread.VThread.wait"><code class="xref py py-meth docutils literal notranslate"><span class="pre">wait()</span></code></a>
call by raising a VThread.KillException.
When the <a class="reference internal" href="../reference/vthread.html#moddy.vthread.VThread.run_vthread" title="moddy.vthread.VThread.run_vthread"><code class="xref py py-meth docutils literal notranslate"><span class="pre">run_vthread()</span></code></a> has terminated, all pending timers are stopped,
all receive queues in the input ports are cleared and no messages can be received while terminated.
The kill message is ignored if the VThread is already terminated.</p></li>
</ul>
</div></blockquote>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Variable persistence: When a thread is re-started, all local variables are lost and must be reinitialized.
However, be aware that variables stored in the <a class="reference internal" href="../reference/core.html#moddy.sim_part.SimPart" title="moddy.sim_part.SimPart"><code class="xref py py-class docutils literal notranslate"><span class="pre">SimPart</span></code></a> object (e.g. self.myvar) will survive a restart.</p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="modelchecking.html" class="btn btn-neutral float-right" title="Model Checking" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="fsm.html" class="btn btn-neutral float-left" title="Modelling with Finite State Machines" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Klaus Popp

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>